<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配对练习(选择文件版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .game-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .column {
            width: 48%;
            min-height: 300px;
            border: 2px solid #3498db;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .word-card {
            background-color: #f1c40f;
            color: #2c3e50;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
            flex: 0 0 auto;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .word-card:hover {
            background-color: #f39c12;
        }
        .word-card.selected {
            background-color: #e74c3c;
            color: white;
        }
        .stats {
            margin-top: 20px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .mistakes {
            margin-top: 20px;
            padding: 10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 5px;
            display: none;
        }
        button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #27ae60;
        }
        button.secondary {
            background-color: #e74c3c;
        }
        button.secondary:hover {
            background-color: #c0392b;
        }
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 100;
        }
        .correct-feedback {
            color: #2ecc71;
        }
        .wrong-feedback {
            color: #e74c3c;
        }
        .topic-info {
            margin: 6px 0 4px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
        }
        .group-info {
            margin: 6px 0 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        .file-import {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px dashed #ccc;
        }
        .file-import p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
        }
        .preview-area {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            margin-bottom: 10px;
        }
        .file-upload {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            border: 1px dashed #4caf50;
        }
        .file-upload h3 {
            color: #2e7d32;
            margin-top: 0;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background-color: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .file-input-wrapper:hover {
            background-color: #45a049;
        }
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .upload-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #666;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f39c12;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .section-title { display: flex; align-items: center; gap: 12px; }
        .section-title .hint { color: #666; font-size: 0.95em; }
        .preset-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .upload-controls { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .upload-info.compact { margin: 0; }
        .file-status-line { margin-top: 8px; color: #666; }
    </style>
</head>
<body>
    <h1>配对练习(选择文件版)</h1>
    
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('preset')">预设信息库</button>
            <button class="tab-button" onclick="switchTab('upload')">上传自定义文件</button>
        </div>
        
        <!-- 预设信息库标签页 -->
        <div id="preset-tab" class="tab-content active">
            <div class="file-import">
                <div class="section-title">
                    <h3>选择预设信息库</h3>
                    <span class="hint">请从下拉菜单中选择预置的信息库文件</span>
                </div>
                <div class="preset-controls">
                    <select id="word-file-select">
                        <option value="">-- 请选择预设信息库 --</option>
                    </select>
                    <button type="button" onclick="refreshPresetFiles()" style="padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">刷新</button>
                </div>
                <div id="preset-loading" style="display: none; color: #f39c12; font-style: italic;">
                    <div class="loading-indicator"></div>
                    <span>正在加载文件...</span>
                </div>
            </div>
        </div>
        
        <!-- 文件上传标签页 -->
        <div id="upload-tab" class="tab-content">
            <div class="file-upload">
                <div class="section-title">
                    <h3>上传自定义Excel文件</h3>
                </div>
                <div class="upload-controls">
                    <div class="file-input-wrapper">
                        <span>选择Excel文件</span>
                        <input type="file" id="custom-file-input" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                        <button type="button" onclick="document.getElementById('custom-file-input').click()" style="margin-left: 10px;">点击选择文件</button>
                    </div>
                    <div class="upload-info compact">
                        <p>支持格式：.xlsx, .xls</p>
                        <p>文件格式要求：第一列为左边内容，第二列为右边内容</p>
                    </div>
                </div>
                <p id="file-status" class="file-status-line"></p>
            </div>
        </div>
    </div>
    
    <div class="topic-info">
        题目: <span id="topic-title">-</span>
    </div>
    <div class="group-info">
        当前组别: <span id="current-group">-</span>/<span id="total-groups">-</span>
    </div>
    
    <div class="game-container">
        <div id="left-column" class="column">
            <h2>左边</h2>
        </div>
        <div id="right-column" class="column">
            <h2>右边</h2>
        </div>
    </div>
    
    <div class="stats">
        <p>剩余配对: <span id="remaining">-</span>/<span id="total-words">-</span></p>
        <p>正确: <span id="correct">0</span> | 错误: <span id="wrong">0</span></p>
    </div>
    
    <div id="mistakes" class="mistakes">
        <h3>错题本</h3>
        <ul id="mistakes-list"></ul>
    </div>
    
    <button id="restart-btn">重新开始</button>
    <button id="end-game-btn" class="secondary">结束游戏</button>
    
    <!-- 反馈提示 -->
    <div id="correct-feedback" class="feedback correct-feedback">✓ 正确!</div>
    <div id="wrong-feedback" class="feedback wrong-feedback">✗ 错误!</div>
    
    <!-- 音频元素 -->
    <audio id="correct-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" preload="auto"></audio>
    
    <script>
        // 游戏状态
        let gameState = {
            wordPairs: [],
            remainingPairs: [],
            leftCards: [],
            rightCards: [],
            selectedCard: null,
            totalCorrectCount: 0,
            currentGroupCorrectCount: 0,
            wrongCount: 0,
            mistakes: [],
            currentGroup: 0,
            totalGroups: 0,
            totalWords: 0,
            matchedPairs: 0,
            originalFileName: ''
        };
        
        // DOM元素
        const leftColumn = document.getElementById('left-column');
        const rightColumn = document.getElementById('right-column');
        const remainingDisplay = document.getElementById('remaining');
        const totalWordsDisplay = document.getElementById('total-words');
        const correctDisplay = document.getElementById('correct');
        const wrongDisplay = document.getElementById('wrong');
        const mistakesDiv = document.getElementById('mistakes');
        const mistakesList = document.getElementById('mistakes-list');
        const restartBtn = document.getElementById('restart-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const currentGroupDisplay = document.getElementById('current-group');
        const totalGroupsDisplay = document.getElementById('total-groups');
        const wordFileSelect = document.getElementById('word-file-select');
        const customFileInput = document.getElementById('custom-file-input');
        const fileStatus = document.getElementById('file-status');
        const topicTitle = document.getElementById('topic-title');
        
        // 预设的Excel文件列表改为从 JSON 加载
        let presetFiles = [];
        let presetFileItems = []; // {name, path}
        
        // 预设文件的数据缓存
        const presetDataCache = {};
        
        // 标签页切换功能
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签页按钮的active状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 设置选中标签页按钮的active状态
            event.target.classList.add('active');
        }
        
        // 获取预设文件列表（从 JSON 加载）
        async function getPresetFileList() {
            try {
                const res = await fetch('words/files.json', { cache: 'no-store' });
                if (!res.ok) throw new Error(`配置文件读取失败(${res.status})`);
                const items = await res.json();
                // 兼容只提供 name 的旧格式
                presetFileItems = items.map(it => ({
                    name: it.name,
                    path: it.path || `words/${it.name}`
                }));
                presetFiles = presetFileItems.map(it => it.name);
                return presetFiles;
            } catch (e) {
                console.error('读取文件列表失败:', e);
                throw e;
            }
        }
        
        // 刷新预设文件列表
        function refreshPresetFiles() {
            // 清空缓存
            Object.keys(presetDataCache).forEach(key => {
                delete presetDataCache[key];
            });
            
            // 重新初始化选择框
            initPresetFileSelect();
            
            // 显示刷新成功消息
            const loadingDiv = document.getElementById('preset-loading');
            loadingDiv.style.display = 'block';
            loadingDiv.innerHTML = '<span style="color: #27ae60;">✓ 文件列表已刷新</span>';
            setTimeout(() => {
                loadingDiv.style.display = 'none';
            }, 2000);
        }
        
        // 根据name查找文件路径
        function findPresetPathByName(name) {
            const item = presetFileItems.find(i => i.name === name);
            return item ? item.path : `words/${name}`;
        }

        // 加载预设文件
        async function loadPresetFile(filename) {
            // 如果缓存中已有数据，直接返回
            if (presetDataCache[filename]) {
                return presetDataCache[filename];
            }
            
            try {
                // 动态读取Excel文件（根据配置决定路径）
                const response = await fetch(findPresetPathByName(filename));
                if (!response.ok) {
                    throw new Error('文件读取失败');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { 
                    header: 1,
                    raw: false,
                    defval: ""
                });
                
                // 过滤空行并转换为配对格式
                const pairs = jsonData
                    .filter(row => row[0] && row[1])
                    .map(row => ({ left: row[0], right: row[1] }));
                
                if (pairs.length === 0) {
                    throw new Error('文件中没有有效数据');
                }
                
                // 缓存数据
                presetDataCache[filename] = pairs;
                return pairs;
                
            } catch (error) {
                console.error('加载预设文件失败:', error);
                throw new Error(`加载文件失败: ${error.message}`);
            }
        }
        
        // 处理文件上传
        function handleFileUpload(event) {
            console.log('文件上传事件触发', event);
            const file = event.target.files[0];
            if (!file) {
                console.log('没有选择文件');
                return;
            }
            console.log('选择的文件:', file.name, file.type, file.size);
            
            // 检查文件类型
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                fileStatus.textContent = '错误：请选择Excel文件(.xlsx或.xls)';
                fileStatus.style.color = '#e74c3c';
                return;
            }
            
            fileStatus.textContent = '正在读取文件...';
            fileStatus.style.color = '#f39c12';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { 
                        header: 1,
                        raw: false,
                        defval: ""
                    });
                    
                    // 过滤空行并转换为配对格式
                    const pairs = jsonData
                        .filter(row => row[0] && row[1])
                        .map(row => ({ left: row[0], right: row[1] }));
                    
                    if (pairs.length === 0) {
                        fileStatus.textContent = '错误：文件中没有有效数据';
                        fileStatus.style.color = '#e74c3c';
                        return;
                    }
                    
                    fileStatus.textContent = `成功读取文件！共找到 ${pairs.length} 个配对`;
                    fileStatus.style.color = '#27ae60';
                    
                    // 自动开始游戏
                    initGame(pairs, file.name.replace(/\.(xlsx|xls)$/i, ''));
                    
                } catch (error) {
                    fileStatus.textContent = '错误：读取文件失败 - ' + error.message;
                    fileStatus.style.color = '#e74c3c';
                    console.error('文件读取错误:', error);
                }
            };
            
            reader.onerror = function() {
                fileStatus.textContent = '错误：文件读取失败';
                fileStatus.style.color = '#e74c3c';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 初始化预设文件选择下拉框
        async function initPresetFileSelect() {
            try {
                // 异步加载文件列表
                const wordFiles = await getPresetFileList();
                wordFileSelect.innerHTML = '';
                
                if (wordFiles.length === 0) {
                    wordFileSelect.innerHTML = '<option value="">没有预设信息文件</option>';
                    return;
                }
                
                // 添加默认提示选项
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- 请选择预设信息库 --';
                wordFileSelect.appendChild(defaultOption);
                
                // 添加预设文件选项
                wordFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.textContent = file.replace(/\.xlsx?$/i, '');
                    option.title = `点击选择 ${file.replace(/\.xlsx?$/i, '')} 信息库`;
                    wordFileSelect.appendChild(option);
                });
                
                // 添加事件监听
                wordFileSelect.addEventListener('change', async function() {
                    const selectedFile = this.value;
                    if (!selectedFile) return;
                    
                    try {
                        // 显示加载状态
                        const loadingDiv = document.getElementById('preset-loading');
                        loadingDiv.style.display = 'block';
                        loadingDiv.innerHTML = `<div class="loading-indicator"></div><span>正在加载 ${selectedFile}...</span>`;
                        
                        const wordPairs = await loadPresetFile(selectedFile);
                        initGame(wordPairs, selectedFile);
                        
                        // 隐藏加载状态
                        loadingDiv.style.display = 'none';
                    } catch (error) {
                        console.error('加载预设文件失败:', error);
                        let errorMessage = '加载预设信息库失败';
                        
                        if (error.message.includes('fetch')) {
                            errorMessage += ': 无法访问文件，请检查文件是否存在';
                        } else if (error.message.includes('XLSX')) {
                            errorMessage += ': 文件格式错误，请确保是有效的Excel文件';
                        } else {
                            errorMessage += ': ' + error.message;
                        }
                        
                        alert(errorMessage);
                        // 重置选择
                        this.value = '';
                        // 隐藏加载状态
                        document.getElementById('preset-loading').style.display = 'none';
                    }
                });
            } catch (error) {
                wordFileSelect.innerHTML = '<option value="">加载预设信息文件列表失败</option>';
                console.error('获取预设信息文件列表失败:', error);
            }
        }
        
        // 初始化游戏
        function initGame(wordPairs, fileName) {
            // 更新题目显示（去掉扩展名）
            if (fileName) {
                const title = fileName.replace(/\.xlsx?$/i, '');
                topicTitle.textContent = title;
            }
            if (!wordPairs || wordPairs.length === 0) {
                alert('请先选择有效的信息库或上传文件');
                return false;
            }
            
            // 重置游戏状态
            gameState = {
                wordPairs: [...wordPairs],
                remainingPairs: [],
                leftCards: [],
                rightCards: [],
                selectedCard: null,
                totalCorrectCount: 0,
                currentGroupCorrectCount: 0,
                wrongCount: 0,
                mistakes: [],
                currentGroup: 1,
                totalGroups: Math.ceil(wordPairs.length / 5),
                totalWords: wordPairs.length,
                matchedPairs: 0,
                originalFileName: fileName.replace(/\.xlsx?$/i, '')
            };
            
            // 更新统计显示
            totalGroupsDisplay.textContent = gameState.totalGroups;
            totalWordsDisplay.textContent = gameState.totalWords;
            
            // 清空列
            leftColumn.innerHTML = '<h2>左边</h2>';
            rightColumn.innerHTML = '<h2>右边</h2>';
            
            // 隐藏错题本
            mistakesDiv.style.display = 'none';
            mistakesList.innerHTML = '';
            
            // 加载第一组单词
            loadCurrentGroup();
            
            // 更新统计
            updateStats();
            
            return true;
        }
        
        // 加载当前组的单词
        function loadCurrentGroup() {
            if (gameState.currentGroup > gameState.totalGroups) {
                endGame();
                return;
            }
            
            currentGroupDisplay.textContent = gameState.currentGroup;
            
            // 清空列
            leftColumn.innerHTML = '<h2>左边</h2>';
            rightColumn.innerHTML = '<h2>右边</h2>';
            
            // 重置选择状态
            gameState.selectedCard = null;
            
            // 重置当前组正确计数
            gameState.currentGroupCorrectCount = 0;
            
            // 设置当前组的单词
            const startIdx = (gameState.currentGroup - 1) * 5;
            const endIdx = Math.min(startIdx + 5, gameState.wordPairs.length);
            gameState.remainingPairs = gameState.wordPairs.slice(startIdx, endIdx);
            
            // 创建卡片
            createCards();
        }
        
        // 创建卡片
        function createCards() {
            // 打乱顺序
            shuffleArray(gameState.remainingPairs);
            
            // 创建左边卡片
            gameState.leftCards = [];
            gameState.remainingPairs.forEach((pair, index) => {
                const card = document.createElement('div');
                card.className = 'word-card';
                card.textContent = pair.left;
                card.dataset.index = index;
                card.addEventListener('click', function() {
                    // 如果没有选中右边卡片，可以切换选择其他左边卡片
                    if (!gameState.selectedCard || gameState.selectedCard.parentElement === leftColumn) {
                        if (gameState.selectedCard) {
                            gameState.selectedCard.classList.remove('selected');
                        }
                        gameState.selectedCard = card;
                        card.classList.add('selected');
                    } else {
                        // 已经选中了右边卡片，尝试配对                  
                        handleCardSelection(card, pair.left);
                    }                   
                });
                leftColumn.appendChild(card);
                gameState.leftCards.push({
                    element: card,
                    pairIndex: index,
                    left: pair.left,
                    right: pair.right
                });
            });
            
            // 创建右边卡片（再次打乱）
            const shuffledright = [...gameState.remainingPairs];
            shuffleArray(shuffledright);
            
            gameState.rightCards = [];
            shuffledright.forEach((pair, index) => {
                const card = document.createElement('div');
                card.className = 'word-card';
                card.textContent = pair.right;
                card.dataset.index = index;
                card.addEventListener('click', function() {
                    // 如果没有选中左边卡片，可以切换选择其他右边卡片
                    if (!gameState.selectedCard || gameState.selectedCard.parentElement === rightColumn) {
                        if (gameState.selectedCard) {
                            gameState.selectedCard.classList.remove('selected');
                        }
                        gameState.selectedCard = card;
                        card.classList.add('selected');
                    } else {
                        // 已经选中了左边卡片，尝试配对
                        handleCardSelection(card);
                    }
                });
                rightColumn.appendChild(card);
                gameState.rightCards.push({
                    element: card,
                    pairIndex: gameState.remainingPairs.findIndex(p => p.right === pair.right),
                    left: pair.left,
                    right: pair.right
                });
            });
        }
        
        // 处理卡片选择
        function handleCardSelection(card, leftText) {
            // 如果已经选中了一张卡片
            if (gameState.selectedCard) {
                // 检查是否匹配
                const isMatch = checkMatch(gameState.selectedCard, card);
                
                // 如果是同一张卡片，不做任何操作
                if (gameState.selectedCard === card) {
                    return;
                }
                
                // 处理匹配结果
                if (isMatch) {
                    handleCorrectMatch(gameState.selectedCard, card);
                    showFeedback(true);
                } else {
                    handleWrongMatch(gameState.selectedCard, card);
                    showFeedback(false);
                }
                
                // 重置选中状态
                gameState.selectedCard.classList.remove('selected');
                gameState.selectedCard = null;
                
                // 检查游戏是否结束
                checkGameEnd();
            } else {
                // 如果没有选中卡片，选中当前卡片
                gameState.selectedCard = card;
                card.classList.add('selected');
            }
        }
        
        // 检查是否匹配
        function checkMatch(card1, card2) {
            // 确定哪张是左边，哪张是右边
            let leftCard, rightCard;
            if (card1.parentElement === leftColumn) {
                leftCard = card1;
                rightCard = card2;
            } else {
                leftCard = card2;
                rightCard = card1;
            }
            
            // 获取对应的pairIndex
            const leftIndex = gameState.leftCards.find(c => c.element === leftCard).pairIndex;
            const rightIndex = gameState.rightCards.find(c => c.element === rightCard).pairIndex;
            
            return leftIndex === rightIndex;
        }
        
        // 处理正确匹配
        function handleCorrectMatch(card1, card2) {
            // 直接隐藏卡片
            card1.style.display = 'none';
            card2.style.display = 'none';
            
            // 更新统计
            gameState.totalCorrectCount++;
            gameState.currentGroupCorrectCount++;
            gameState.matchedPairs++;
            updateStats();
        }
        
        // 处理错误匹配
        function handleWrongMatch(card1, card2) {
            // 确定哪张是左边，哪张是右边
            let leftCard, rightCard;
            if (card1.parentElement === leftColumn) {
                leftCard = card1;
                rightCard = card2;
            } else {
                leftCard = card2;
                rightCard = card1;
            }
            
            // 获取对应的pairIndex
            const leftIndex = gameState.leftCards.find(c => c.element === leftCard).pairIndex;
            const rightIndex = gameState.rightCards.find(c => c.element === rightCard).pairIndex;
            
            // 记录错误
            const leftWord = gameState.leftCards.find(c => c.element === leftCard).left;
            const correctright = gameState.leftCards.find(c => c.element === leftCard).right;
            const selectedright = gameState.rightCards.find(c => c.element === rightCard).right;
            
            const mistake = {
                left: leftWord,
                correctright: correctright,
                selectedright: selectedright
            };
            gameState.mistakes.push(mistake);
            
            // 只取消选择
            leftCard.classList.remove('selected');
            rightCard.classList.remove('selected');
            
            // 更新统计
            gameState.wrongCount++;
            updateStats();
        }
        
        // 更新统计
        function updateStats() {
            const remaining = gameState.totalWords - gameState.matchedPairs;
            remainingDisplay.textContent = remaining;
            correctDisplay.textContent = gameState.totalCorrectCount;
            wrongDisplay.textContent = gameState.wrongCount;
        }
        
        // 检查游戏是否结束
        function checkGameEnd() {
            // 检查当前组是否完成
            if (gameState.currentGroupCorrectCount === gameState.remainingPairs.length) {
                // 检查是否还有下一组
                if (gameState.currentGroup < gameState.totalGroups) {
                    // 加载下一组
                    gameState.currentGroup++;
                    gameState.leftCards = [];
                    gameState.rightCards = [];
                    loadCurrentGroup();
                } else {
                    // 游戏全部完成
                    showMistakes();
                    downloadMistakes();
                }
            }
        }
        
        // 结束游戏并显示错题本
        function endGame() {
            showMistakes();
            downloadMistakes();
        }
        
        // 显示错题本
        function showMistakes() {
            if (gameState.mistakes.length > 0) {
                mistakesDiv.style.display = 'block';
                mistakesList.innerHTML = '';
                gameState.mistakes.forEach(mistake => {
                    const li = document.createElement('li');
                    li.textContent = `${capitalizeFirstLetter(mistake.left)}---${mistake.selectedright}，正确：${mistake.correctright}`;
                    mistakesList.appendChild(li);
                });
            } else {
                mistakesDiv.style.display = 'block';
                mistakesList.innerHTML = '<li>没有错误记录！</li>';
            }
        }
        
        // 下载错题本功能
        function downloadMistakes() {
            if (gameState.mistakes.length === 0) return;
            
            // 获取当前时间并格式化为文件名
            const now = new Date();
            const timeStr = [
                now.getFullYear(),
                String(now.getMonth() + 1).padStart(2, '0'),
                String(now.getDate()).padStart(2, '0'),
                '_',
                String(now.getHours()).padStart(2, '0'),
                String(now.getMinutes()).padStart(2, '0'),
                String(now.getSeconds()).padStart(2, '0')
            ].join('');
            
            const fileName = `${gameState.originalFileName}_错题本_${timeStr}.xlsx`;
            
            // 准备数据
            const data = [
                ['左边', '错误选择', '正确答案'], // 表头
                ...gameState.mistakes.map(mistake => [
                    mistake.left, 
                    mistake.selectedright, 
                    mistake.correctright
                ])
            ];
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // 设置列宽
            ws['!cols'] = [
                { wch: 30 }, // 英文列
                { wch: 30 }, // 错误选择列
                { wch: 30 }  // 正确答案列
            ];
            XLSX.utils.book_append_sheet(wb, ws, "错题本");
            
            // 生成Excel文件并下载
            XLSX.writeFile(wb, fileName);
        }
        
        // 语音合成
        const synth = window.speechSynthesis;
        let voices = [];
        
        function loadVoices() {
            voices = synth.getVoices();
        }
        
        // 初始化时加载语音
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        
        // 朗读单词/句子
        function speakWord(word) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(word);
            
            // 查找英式英语发音
            const ukVoice = voices.find(voice => 
                voice.lang.includes('en-GB') || voice.lang.includes('en-UK')
            );
            
            if (ukVoice) {
                utterance.voice = ukVoice;
            } else {
                // 如果没有英式发音，使用第一个英语发音
                const enVoice = voices.find(voice => voice.lang.includes('en'));
                if (enVoice) {
                    utterance.voice = enVoice;
                }
            }
            
            synth.speak(utterance);
        }
        
        // 显示反馈
        function showFeedback(isCorrect) {
            const feedback = isCorrect ? document.getElementById('correct-feedback') : document.getElementById('wrong-feedback');
            const sound = isCorrect ? document.getElementById('correct-sound') : document.getElementById('wrong-sound');
            
            feedback.style.opacity = '1';
            sound.currentTime = 0;
            sound.play();
            
            setTimeout(() => {
                feedback.style.opacity = '0';
            }, 1000);
        }
        
        // 首字母大写
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // 辅助函数：打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // 事件监听
        restartBtn.addEventListener('click', () => {
            if (gameState.wordPairs.length > 0) {
                initGame(gameState.wordPairs, gameState.originalFileName);
            } else {
                alert('请先选择信息库或上传文件');
            }
        });
        
        endGameBtn.addEventListener('click', endGame);
        
        // 初始化预设文件选择下拉框
        initPresetFileSelect();
        
        // 调试信息
        console.log('页面初始化完成');
        console.log('文件状态元素:', fileStatus);
        console.log('自定义文件输入元素:', customFileInput);
        console.log('文件上传处理函数:', typeof handleFileUpload);
    </script>
</body>
</html>