<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语单词配对和对话学习(Excel导入版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .game-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .column {
            width: 48%;
            min-height: 300px;
            border: 2px solid #3498db;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .word-card {
            background-color: #f1c40f;
            color: #2c3e50;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
            flex: 0 0 auto;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .word-card:hover {
            background-color: #f39c12;
        }
        .word-card.selected {
            background-color: #e74c3c;
            color: white;
        }
        .stats {
            margin-top: 20px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .mistakes {
            margin-top: 20px;
            padding: 10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 5px;
            display: none;
        }
        button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #27ae60;
        }
        button.secondary {
            background-color: #e74c3c;
        }
        button.secondary:hover {
            background-color: #c0392b;
        }
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 100;
        }
        .correct-feedback {
            color: #2ecc71;
        }
        .wrong-feedback {
            color: #e74c3c;
        }
        .group-info {
            margin: 10px 0;
            font-weight: bold;
            color: #2c3e50;
        }
        .file-import {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px dashed #ccc;
        }
        .file-import p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
        }
        .preview-area {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>英语单词配对和对话学习(Excel导入版)</h1>
    
    <div class="file-import">
        <h3>导入单词库</h3>
        <input type="file" id="excel-file" accept=".xlsx,.xls">
        <p>请上传Excel文件，第一列为英文（问句），第二列为中文（答句）</p>
        <p>支持单词或句子，标点符号将保留</p>
        <div class="preview-area" id="file-preview">
            <p>文件内容将显示在这里...</p>
        </div>
    </div>
    
    <div class="group-info">
        当前组别: <span id="current-group">-</span>/<span id="total-groups">-</span>
    </div>
    
    <div class="game-container">
        <div id="english-column" class="column">
            <h2>英文（问句）</h2>
        </div>
        <div id="chinese-column" class="column">
            <h2>中文（答句）</h2>
        </div>
    </div>
    
    <div class="stats">
        <p>剩余配对: <span id="remaining">-</span>/<span id="total-words">-</span></p>
        <p>正确: <span id="correct">0</span> | 错误: <span id="wrong">0</span></p>
    </div>
    
    <div id="mistakes" class="mistakes">
        <h3>错题本</h3>
        <ul id="mistakes-list"></ul>
    </div>
    
    <button id="restart-btn">重新开始</button>
    <button id="end-game-btn" class="secondary">结束游戏</button>
    
    <!-- 反馈提示 -->
    <div id="correct-feedback" class="feedback correct-feedback">✓ 正确!</div>
    <div id="wrong-feedback" class="feedback wrong-feedback">✗ 错误!</div>
    
    <!-- 音频元素 -->
    <audio id="correct-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" preload="auto"></audio>
    
    <script>
        // 游戏状态
        let gameState = {
            wordPairs: [],
            remainingPairs: [],
            englishCards: [],
            chineseCards: [],
            selectedCard: null,
            totalCorrectCount: 0,
            currentGroupCorrectCount: 0,
            wrongCount: 0,
            mistakes: [],
            currentGroup: 0,
            totalGroups: 0,
            totalWords: 0,
            matchedPairs: 0,
			originalFileName: '' // 新增：存储原始文件名（不含扩展名）
        };
        
        // DOM元素
        const englishColumn = document.getElementById('english-column');
        const chineseColumn = document.getElementById('chinese-column');
        const remainingDisplay = document.getElementById('remaining');
        const totalWordsDisplay = document.getElementById('total-words');
        const correctDisplay = document.getElementById('correct');
        const wrongDisplay = document.getElementById('wrong');
        const mistakesDiv = document.getElementById('mistakes');
        const mistakesList = document.getElementById('mistakes-list');
        const restartBtn = document.getElementById('restart-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const excelFileInput = document.getElementById('excel-file');
        const filePreview = document.getElementById('file-preview');
        const currentGroupDisplay = document.getElementById('current-group');
        const totalGroupsDisplay = document.getElementById('total-groups');
        
        // 显示文件预览(只显示前5行)
        function showFilePreview(wordPairs) {
            filePreview.innerHTML = '';
            
            if (!wordPairs || wordPairs.length === 0) {
                filePreview.innerHTML = '<p>没有可显示的内容</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            
            // 添加表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['英文(问句)', '中文(答句)'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                th.style.border = '1px solid #ddd';
                th.style.padding = '8px';
                th.style.textAlign = 'left';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 添加内容(只显示前5行)
            const tbody = document.createElement('tbody');
            wordPairs.slice(0, 5).forEach(pair => {
                const row = document.createElement('tr');
                
                [pair.english, pair.chinese].forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    td.style.border = '1px solid #ddd';
                    td.style.padding = '8px';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            filePreview.appendChild(table);
            
            if (wordPairs.length > 5) {
                const info = document.createElement('p');
                info.textContent = `...还有 ${wordPairs.length - 5} 行未显示`;
                info.style.marginTop = '10px';
                info.style.textAlign = 'center';
                filePreview.appendChild(info);
            }
            
            const countInfo = document.createElement('p');
            countInfo.textContent = `共找到 ${wordPairs.length} 个单词/句子对`;
            countInfo.style.marginTop = '10px';
            countInfo.style.fontWeight = 'bold';
            filePreview.appendChild(countInfo);
        }
        
        // 解析Excel文件
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // 获取第一列(英文)和第二列(中文)
                        const wordPairs = jsonData
                            .filter(row => row.length >= 2 && row[0] && row[1])
                            .map(row => ({
                                english: String(row[0]).trim(),
                                chinese: String(row[1]).trim()
                            }));
                        
                        resolve({
								wordPairs: wordPairs, // 单词对数组
								fileName: file.name.replace(/\.[^/.]+$/, "") // 新增：移除扩展名的文件名
								});
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 初始化游戏
        function initGame(wordPairs,fileName) {
            if (!wordPairs || wordPairs.length === 0) {
                alert('请先导入有效的Excel文件');
                return false;
            }
            
            // 重置游戏状态
            gameState = {
                wordPairs: [...wordPairs],
                remainingPairs: [],
                englishCards: [],
                chineseCards: [],
                selectedCard: null,
                totalCorrectCount: 0,
                currentGroupCorrectCount: 0,
                wrongCount: 0,
                mistakes: [],
                currentGroup: 1,
                totalGroups: Math.ceil(wordPairs.length / 5),
                totalWords: wordPairs.length,
                matchedPairs: 0,
				originalFileName: fileName
            };
            
            // 显示文件预览(前5行)
            showFilePreview(wordPairs);
            
            // 更新统计显示
            totalGroupsDisplay.textContent = gameState.totalGroups;
            totalWordsDisplay.textContent = gameState.totalWords;
            
            // 清空列
            englishColumn.innerHTML = '<h2>英文(问句)</h2>';
            chineseColumn.innerHTML = '<h2>中文(答句)</h2>';
            
            // 隐藏错题本
            mistakesDiv.style.display = 'none';
            mistakesList.innerHTML = '';
            
            // 加载第一组单词
            loadCurrentGroup();
            
            // 更新统计
            updateStats();
            
            return true;
        }
        
        // 加载当前组的单词
        function loadCurrentGroup() {
            if (gameState.currentGroup > gameState.totalGroups) {
                endGame();
                return;
            }
            
            currentGroupDisplay.textContent = gameState.currentGroup;
            
            // 清空列
            englishColumn.innerHTML = '<h2>英文(问句)</h2>';
            chineseColumn.innerHTML = '<h2>中文(答句)</h2>';
            
            // 重置选择状态
            gameState.selectedCard = null;
            
            // 重置当前组正确计数
            gameState.currentGroupCorrectCount = 0;
            
            // 设置当前组的单词
            const startIdx = (gameState.currentGroup - 1) * 5;
            const endIdx = Math.min(startIdx + 5, gameState.wordPairs.length);
            gameState.remainingPairs = gameState.wordPairs.slice(startIdx, endIdx);
            
            // 创建卡片
            createCards();
        }
        
        // 创建卡片
        function createCards() {
            // 打乱顺序
            shuffleArray(gameState.remainingPairs);
            
            // 创建英文卡片
            gameState.englishCards = [];
            gameState.remainingPairs.forEach((pair, index) => {
                const card = document.createElement('div');
                card.className = 'word-card';
                card.textContent = pair.english;
                card.dataset.index = index;
                card.addEventListener('click', function() {
                    
					// 点击英文单词时朗读
                    speakWord(pair.english);
                    
                    // 如果没有选中中文卡片，可以切换选择其他英文卡片
                    if (!gameState.selectedCard || gameState.selectedCard.parentElement === englishColumn) {
                        if (gameState.selectedCard) {
                            gameState.selectedCard.classList.remove('selected');
                        }
                        gameState.selectedCard = card;
                        card.classList.add('selected');
                    } else {
                        // 已经选中了中文卡片，尝试配对
                        //handleCardClick(event);
						handleCardSelection(card, pair.english);
                    }
                });
                englishColumn.appendChild(card);
                gameState.englishCards.push({
                    element: card,
                    pairIndex: index,
                    english: pair.english,
                    chinese: pair.chinese
                });
            });
            
            // 创建中文卡片（再次打乱）
            const shuffledChinese = [...gameState.remainingPairs];
            shuffleArray(shuffledChinese);
            
            gameState.chineseCards = [];
            shuffledChinese.forEach((pair, index) => {
                const card = document.createElement('div');
                card.className = 'word-card';
                card.textContent = pair.chinese;
                card.dataset.index = index;
                card.addEventListener('click', function() {
                    
					// 如果没有选中英文卡片，可以切换选择其他中文卡片
                    if (!gameState.selectedCard || gameState.selectedCard.parentElement === chineseColumn) {
                        if (gameState.selectedCard) {
                            gameState.selectedCard.classList.remove('selected');
                        }
                        gameState.selectedCard = card;
                        card.classList.add('selected');
                    } else {
                        // 已经选中了英文卡片，尝试配对
                        //handleCardClick(event);
						handleCardSelection(card);
                    }
                });
                chineseColumn.appendChild(card);
                gameState.chineseCards.push({
                    element: card,
                    pairIndex: gameState.remainingPairs.findIndex(p => p.chinese === pair.chinese),
                    english: pair.english,
                    chinese: pair.chinese
                });
            });
        }
        
        // 处理卡片选择
        function handleCardSelection(card, englishText) {
            if (englishText) {
                // 如果是英文卡片，朗读内容
                speakWord(englishText);
            }
            
            // 如果已经选中了一张卡片
            if (gameState.selectedCard) {
                // 检查是否匹配
                const isMatch = checkMatch(gameState.selectedCard, card);
                
                // 如果是同一张卡片，不做任何操作
                if (gameState.selectedCard === card) {
                    return;
                }
                
                // 处理匹配结果
                if (isMatch) {
                    handleCorrectMatch(gameState.selectedCard, card);
                    showFeedback(true);
                } else {
                    handleWrongMatch(gameState.selectedCard, card);
                    showFeedback(false);
                }
                
                // 重置选中状态
                gameState.selectedCard.classList.remove('selected');
                gameState.selectedCard = null;
                
                // 检查游戏是否结束
                checkGameEnd();
            } else {
                // 如果没有选中卡片，选中当前卡片
                gameState.selectedCard = card;
                card.classList.add('selected');
            }
        }
        
        // 检查是否匹配
        function checkMatch(card1, card2) {
            // 确定哪张是英文，哪张是中文
            let englishCard, chineseCard;
            if (card1.parentElement === englishColumn) {
                englishCard = card1;
                chineseCard = card2;
            } else {
                englishCard = card2;
                chineseCard = card1;
            }
            
            // 获取对应的pairIndex
            const englishIndex = gameState.englishCards.find(c => c.element === englishCard).pairIndex;
            const chineseIndex = gameState.chineseCards.find(c => c.element === chineseCard).pairIndex;
            
            return englishIndex === chineseIndex;
        }
        
        // 处理正确匹配
        function handleCorrectMatch(card1, card2) {
            // 直接隐藏卡片
            card1.style.display = 'none';
            card2.style.display = 'none';
            
            // 更新统计
            gameState.totalCorrectCount++;
            gameState.currentGroupCorrectCount++;
            gameState.matchedPairs++;
            updateStats();
        }
        
        // 处理错误匹配
        function handleWrongMatch(card1, card2) {
            // 确定哪张是英文，哪张是中文
            let englishCard, chineseCard;
            if (card1.parentElement === englishColumn) {
                englishCard = card1;
                chineseCard = card2;
            } else {
                englishCard = card2;
                chineseCard = card1;
            }
            
            // 获取对应的pairIndex
            const englishIndex = gameState.englishCards.find(c => c.element === englishCard).pairIndex;
            const chineseIndex = gameState.chineseCards.find(c => c.element === chineseCard).pairIndex;
            
            // 记录错误
            const englishWord = gameState.englishCards.find(c => c.element === englishCard).english;
            const correctChinese = gameState.englishCards.find(c => c.element === englishCard).chinese;
            const selectedChinese = gameState.chineseCards.find(c => c.element === chineseCard).chinese;
            
            const mistake = {
                english: englishWord,
                correctChinese: correctChinese,
                selectedChinese: selectedChinese
            };
            gameState.mistakes.push(mistake);
            
            // 只取消选择
            englishCard.classList.remove('selected');
            chineseCard.classList.remove('selected');
            
            // 更新统计
            gameState.wrongCount++;
            updateStats();
        }
        
        // 更新统计
        function updateStats() {
            const remaining = gameState.totalWords - gameState.matchedPairs;
            remainingDisplay.textContent = remaining;
            correctDisplay.textContent = gameState.totalCorrectCount;
            wrongDisplay.textContent = gameState.wrongCount;
        }
        
        // 检查游戏是否结束
        function checkGameEnd() {
            // 检查当前组是否完成
            if (gameState.currentGroupCorrectCount === gameState.remainingPairs.length) {
                // 检查是否还有下一组
                if (gameState.currentGroup < gameState.totalGroups) {
                    // 加载下一组
                    gameState.currentGroup++;
                    gameState.englishCards = [];
                    gameState.chineseCards = [];
                    loadCurrentGroup();
                } else {
                    // 游戏全部完成
                    showMistakes();
                    downloadMistakes(); // 新增：游戏结束时自动下载错题本
                }
            }
        }
        
        // 结束游戏并显示错题本
        function endGame() {
            showMistakes();
            downloadMistakes(); // 新增：手动结束游戏时也下载错题本
        }
        
        // 显示错题本
        function showMistakes() {
            if (gameState.mistakes.length > 0) {
                mistakesDiv.style.display = 'block';
                mistakesList.innerHTML = '';
                gameState.mistakes.forEach(mistake => {
                    const li = document.createElement('li');
                    li.textContent = `${capitalizeFirstLetter(mistake.english)}---${mistake.selectedChinese}，正确：${mistake.correctChinese}`;
                    mistakesList.appendChild(li);
                });
            } else {
                mistakesDiv.style.display = 'block';
                mistakesList.innerHTML = '<li>没有错误记录！</li>';
            }
        }
        
        // 新增：下载错题本功能
        function downloadMistakes() {
            if (gameState.mistakes.length === 0) return;
            
            // 获取当前时间并格式化为文件名
            const now = new Date();
            const timeStr = [
			now.getFullYear(),
			String(now.getMonth() + 1).padStart(2, '0'),
			String(now.getDate()).padStart(2, '0'),
			'_',
			String(now.getHours()).padStart(2, '0'),
			String(now.getMinutes()).padStart(2, '0'),
			String(now.getSeconds()).padStart(2, '0')
		].join('');
            
             const fileName = `${gameState.originalFileName}_错题本_${timeStr}.xlsx`;
            
            // 准备数据
            const data = [
                ['英文', '错误选择', '正确答案'], // 表头
                ...gameState.mistakes.map(mistake => [
                    mistake.english, 
                    mistake.selectedChinese, 
                    mistake.correctChinese
                ])
            ];
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
			// 设置列宽
			ws['!cols'] = [
			{ wch: 30 }, // 英文列
			{ wch: 30 }, // 错误选择列
			{ wch: 30 }  // 正确答案列
			];
            XLSX.utils.book_append_sheet(wb, ws, "错题本");
            
            // 生成Excel文件并下载
            XLSX.writeFile(wb, fileName);
        }
        
        // 语音合成
        const synth = window.speechSynthesis;
        let voices = [];
        
        function loadVoices() {
            voices = synth.getVoices();
        }
        
        // 初始化时加载语音
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        
        // 朗读单词/句子
        function speakWord(word) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(word);
            
            // 查找英式英语发音
            const ukVoice = voices.find(voice => 
                voice.lang.includes('en-GB') || voice.lang.includes('en-UK')
            );
            
            if (ukVoice) {
                utterance.voice = ukVoice;
            } else {
                // 如果没有英式发音，使用第一个英语发音
                const enVoice = voices.find(voice => voice.lang.includes('en'));
                if (enVoice) {
                    utterance.voice = enVoice;
                }
            }
            
            synth.speak(utterance);
        }
        
        // 显示反馈
        function showFeedback(isCorrect) {
            const feedback = isCorrect ? document.getElementById('correct-feedback') : document.getElementById('wrong-feedback');
            const sound = isCorrect ? document.getElementById('correct-sound') : document.getElementById('wrong-sound');
            
            feedback.style.opacity = '1';
            sound.currentTime = 0;
            sound.play();
            
            setTimeout(() => {
                feedback.style.opacity = '0';
            }, 1000);
        }
        
        // 首字母大写
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // 辅助函数：打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // 事件监听
        excelFileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const result = await parseExcelFile(file);
                if (result.wordPairs.length === 0) {
                    alert('Excel文件中没有有效的单词对，请检查格式');
                    return;
                }
                
                // 先显示预览
                showFilePreview(result.wordPairs);
                
                // 然后初始化游戏
                if (!initGame(result.wordPairs, result.fileName)) {
                    return;
                }
            } catch (error) {
                alert('解析Excel文件失败，请检查文件格式是否正确');
                console.error(error);
            }
        });
        
        restartBtn.addEventListener('click', () => {
            if (gameState.wordPairs.length > 0) {
                initGame(gameState.wordPairs, gameState.originalFileName);
            } else {
                alert('请先导入单词库');
            }
        });
        
        endGameBtn.addEventListener('click', endGame);
    </script>
</body>
</html>